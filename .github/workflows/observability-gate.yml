name: ğŸ”’ Observability Security Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  dependency-security:
    name: ğŸ” Dependency & Security Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements.otel.txt ]; then pip install -r requirements.otel.txt; fi

      - name: ğŸ” Check dependency conflicts
        run: |
          echo "ğŸ” Checking for version conflicts..."
          pip check
          echo "âœ… No dependency conflicts found"

      - name: ğŸ›¡ï¸ Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          exit-code: '1'
          severity: 'HIGH,CRITICAL'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  metric-validation:
    name: ğŸ“ Metric Taxonomy Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Validate metric naming conventions
        run: |
          echo "ğŸ” Checking metric naming conventions..."
          
          # Check that all Gauge/Counter declarations include units
          INVALID_METRICS=$(grep -r "Gauge\|Counter" --include="*.py" . | \
            grep -v "_ms\|_total\|_bytes\|_seconds\|_hours\|_score\|_percent" || true)
          
          if [ ! -z "$INVALID_METRICS" ]; then
            echo "âŒ Invalid metric names found (missing units):"
            echo "$INVALID_METRICS"
            echo ""
            echo "âœ… Valid examples:"
            echo "  - neuros_hrv_rmssd_ms (milliseconds)"
            echo "  - neuros_sleep_debt_hours (hours)" 
            echo "  - neuros_risk_events_total (counter)"
            exit 1
          fi
          
          echo "âœ… All metrics follow naming conventions"

      - name: ğŸ“Š Check metric cardinality
        run: |
          echo "ğŸ” Checking for high-cardinality patterns..."
          
          # Look for potentially high-cardinality labels
          HIGH_CARD=$(grep -r "labels.*user_id.*timestamp\|labels.*session_id.*user" --include="*.py" . || true)
          
          if [ ! -z "$HIGH_CARD" ]; then
            echo "âš ï¸ Potential high-cardinality metrics found:"
            echo "$HIGH_CARD"
            echo ""
            echo "ğŸ’¡ Consider aggregating or using relabel_configs to drop high-cardinality labels"
            # Warning only, don't fail build
          fi
          
          echo "âœ… Cardinality check complete"

  yaml-validation:
    name: ğŸ“ YAML Configuration Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Validate YAML files
        run: |
          # Install yamllint
          pip install yamllint
          
          echo "ğŸ” Validating YAML configuration files..."
          
          # Check KPI registry
          if [ -f "agents/shared_modules/kpi_registry.yaml" ]; then
            yamllint agents/shared_modules/kpi_registry.yaml
            echo "âœ… KPI registry YAML valid"
          fi
          
          # Check Docker Compose files
          find . -name "docker-compose*.yml" -exec yamllint {} \;
          echo "âœ… Docker Compose YAML files valid"
          
          # Check Grafana provisioning
          if [ -d "grafana/provisioning" ]; then
            find grafana/provisioning -name "*.yml" -exec yamllint {} \;
            echo "âœ… Grafana provisioning YAML valid"
          fi

  kpi-registry-validation:
    name: ğŸ¯ KPI Registry Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install validation dependencies
        run: |
          pip install pydantic pyyaml

      - name: ğŸ¯ Validate KPI registry structure
        run: |
          if [ -f "agents/shared_modules/kpi_registry.yaml" ]; then
            echo "ğŸ” Validating KPI registry structure..."
            
            # Run KPI binding validation if script exists
            if [ -f "agents/validate_kpi_bindings.py" ]; then
              cd agents && python validate_kpi_bindings.py
              echo "âœ… KPI registry validation passed"
            else
              echo "âš ï¸ KPI validation script not found - skipping detailed validation"
            fi
          else
            echo "âš ï¸ KPI registry not found - skipping validation"
          fi

  docker-build-test:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Test Docker build
        run: |
          echo "ğŸ” Testing Docker build process..."
          
          # Test build without pushing (dry run)
          if [ -f "Dockerfile" ]; then
            docker buildx build --platform linux/amd64 --load .
            echo "âœ… Docker build successful"
          else
            echo "âš ï¸ No Dockerfile found - skipping build test"
          fi

  security-summary:
    name: ğŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-security, metric-validation, yaml-validation, kpi-registry-validation]
    if: always()
    steps:
      - name: ğŸ“Š Generate security report
        run: |
          echo "ğŸ”’ AUREN Observability Security Gate Summary"
          echo "============================================="
          echo ""
          echo "âœ… Dependency conflicts: ${{ needs.dependency-security.result }}"
          echo "âœ… Metric taxonomy: ${{ needs.metric-validation.result }}"
          echo "âœ… YAML validation: ${{ needs.yaml-validation.result }}"
          echo "âœ… KPI registry: ${{ needs.kpi-registry-validation.result }}"
          echo ""
          echo "ğŸ¯ All observability standards validated"
          echo "ğŸš€ Ready for agent deployment"